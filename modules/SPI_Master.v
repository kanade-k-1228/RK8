/////////////////////////////////////////////////////////////////////////////////////////
// SPI Master
/////////////////////////////////////////////////////////////////////////////////////////
//
//  SCLK:
//  Mode : CPOL : CPHA :    :    ___:    ___:    ___:    ___:
//  0    : 0    : 0    : ___:___|   |___|   |___|   |___|   |__
//       :      :           :___    :___    :___    :___    :
//  1    : 0    : 1    : ___|   |___|   |___|   |___|   |___:__
//       :      :      : ___:___    :___    :___    :___    ;__
//  2    : 1    : 0    :    :   |___|   |___|   |___|   |___|
//       :      :      : ___:    ___:    ___:    ___:    ___:
//  3    : 1    : 1    :    |___|   |___|   |___|   |___|   |__
//                          :       :       :       :       :
//  MOSI / MISO:            |   7   |   6   |   :   |   0   |
//
//  CPOL: Clock Polarity /  CPHA: Clock Phase
//
// Timing (Mode 0) ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//             _   _   _   _   _   _   _   _   _   _   _   _   _   _   _   _   _   _   _   _   _   _   _   _   _   _   _   _   _   _   _   _   _   _   _   _
//  clk      :  |_| |_| |_| |_| |_| |_| |_| |_| |_| |_| |_| |_| |_| |_| |_| |_| |_| |_| |_| |_| |_| |_| |_| |_| |_| |_| |_| |_| |_| |_| |_| |_| |_| |_| |_| |_
//               _:_____                         _:___:_                              :                               :                               :
//  tx_valid : _| :     |_______________________| :   : |_____________________________:_______________________________:_______________________________:_______
//             ___^ pos clk & valid -> send       :___:                               :_______________________________:_______________________________:_______
//  tx_ready :    |_______________________________|   |_______________________________|                               :                               :
//                :                               :   :                               :                               :                               :
//  state    :  0 |  1  :  sending                | 0 |  1  :  sending                |   2 : receiving               :  2  :  receiving              :   0
//                :                               :   :                               :                               :                               :
//  count    :  - | 0 | 1 | 2 | 3 | 4 | : | E | F | - | 0 | 1 | 2 | 3 | 4 | : | E | F |   -                           :   -                           :   -
//                :    ___     ___     ___     ___:   :    ___     ___     ___     ___:    ___     ___     ___     ___:    ___     ___     ___     ___:
//  SCL      : ___:___|   |___|   |___|   |___|   |___:___|   |___|   |___|   |___|   |___|   |___|   |___|   |___|   |___|   |___|   |___|   |___|   |_______
//                :                               :   :                               :                               :                               :
//  MOSI     :  - |  [7]  |  [6]  |   :   |  [0]  | - |  [7]  |  [6]  |   :   |  [0]  |   -   -   -   -   -   -   -   :   -   -   -   -   -   -   -   :   -
//                :                               :   :                               :                               :                               :
//  MISO     :    :   -   -   -   -   -   -   -   :   :   -   -   -   -   -   -   -   |  [7]  |  [6]  |   :   |  [0]  |                               :
//                :                               :   :                               :                               :                               :
//  rx_valid : ___:_______________________________:___:_______________________________:_______________________________|   |___________________________:_______
//
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//
//
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

module SPI_Master #(
    parameter SPI_MODE = 0
)(
    // Control Signals,
    input rstn,
    input clk,

    // TX (MOSI) Signals
    input      [7:0] tx_data,  // Byte to transmit on MOSI
    input            tx_valid, // Data Valid Pulse with i_TX_Byte
    output reg       tx_ready, // Transmit Ready for next byte

    // RX (MISO) Signals
    output reg       rx_valid, // Data Valid pulse (1 clock cycle)
    output reg [7:0] rx_data,  // Byte received on MISO

    // SPI Interface
    output reg scl,
    output reg mosi
    input      miso,
);

assign CPOL  = (SPI_MODE == 2) | (SPI_MODE == 3);
assign CPHA  = (SPI_MODE == 1) | (SPI_MODE == 3);

////////////////////////////////////////////
// Send Data
////////////////////////////////////////////

reg [3:0] send_state;


////////////////////////////////////////////
// Receive Data
////////////////////////////////////////////
reg [7:0] rx_data_buf;
SIPO rx_sr (
    .clk(clk_norm),
    .rstn(rstn),
    .serial_in(miso),
    .parallel_out(rx_data_buf)
);
// Set received data and send valid signal
always @(posedge recev_done) begin
    rx_data <= rx_data_buf;
    rx_valid <= 1'b1;
end

endmodule
